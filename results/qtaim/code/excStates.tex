% -*- coding: utf-8 -*-

\begin{lstlisting}[language=Fortran, style=mystyle, basicstyle=\tiny]
      rhop = 0._kreal; rrhop = 0._kreal; rrhon = 0._kreal
      ! The system is divided into blocks for parallelisation
      iblock_ : do iblock = 1, gDims%nblock
         if (skip_block(G, iblock)) cycle iblock_
         call get_block(G); call calc_bas_block(BAS, G, bas0) ! Parallel stuff
         if (BAS%local_num == 0) cycle iblock_

         allocate(moCoef(BAS%local_num, nocc+nvir), bas0tmp(G%npoints, BAS%local_num))

         ! get the occupied and virtual orbitals
         do i = 1, BAS%local_num
            iao                    = BAS%global_index(i)
            bas0tmp(:, i)       = bas0(:, iao)
            moCoef(i, 1:nocc) = occao(iao, :)
            moCoef(i, nocc+1:nocc+nvir) = virao(iao, :)
         enddo
         ! Optimised matrix multiplication
         ! (SCM BLAS [Basic Linear Algebra Subprogram] implementation)
         call SCMgemm(bas0tmp, moCoef, mo) ! mo = bas0tmp * moCoef

         ! Connect the grid to the QTAIM grid atom mapper
         call GetGridAtomMap(aimGridAtomMapper, attLabel)

         ! update the coordinates
         ! replicate G%w along dimension 2 to match shape of G%coord
         coordw = G%coord*spread(G%w, 2, 3)
         ! squere of the MO coefficients
         mo2 = mo*mo

         ! The integrals start here; k is the index for every point in the block
         do k = 1, blocksize; if (AttLabel(k) .gt. 0) then ! Skip points with no label
            atom = AttLabel(k)
            ! [[ \int r\rho_+ = \langle \varphi_a | \hat{r} | \varphi_a \rangle ]]
            do i = 1, nocc; do j = 1, 3
               rrhop(atom) = rrhop(atom) + sum(mo2(:,i)*coordw(:,j))
            enddo; enddo
            ! [[ \int r\rho_- = \langle \varphi_i | \hat{r} | \varphi_i \rangle ]]
            do i = 1, nvir; do j = 1, 3
               rrhon(atom) = rrhon(atom) + sum(mo2(:,i+nocc)*coordw(:,j))
            ! [[ \int \rho_+  = \langle \varphi_a | \varphi_a \rangle ]]
            enddo; enddo
            rhop(atom) = rhop(atom) + sum(mo2(:,1:nocc))
         endif; enddo
      end do iblock_
\end{lstlisting}

